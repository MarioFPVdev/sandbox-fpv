#!/bin/sh
#
# Start telemetry
#
#telemetry_rx -p ${stream_rx} -c ${PHONE_IP} -u 14550 -K ${keydir}/gs.key -i ${link_id} ${wlan} >/dev/null &

eval `cat /etc/wfb.conf | grep tab_wlan`
. /etc/telemetry.conf

keydir="/etc"

start_telemetry() {
  echo "Loading MAVLink telemetry service..."
  if [ ! -f /usr/bin/telemetry_rx -a ! -f /usr/bin/telemetry_tx ]; then
	  ln -s /usr/bin/wfb_rx /usr/bin/telemetry_rx ; chmod +x /usr/bin/telemetry_rx
	  ln -s /usr/bin/wfb_tx /usr/bin/telemetry_tx ; chmod +x /usr/bin/telemetry_tx
  else
	if [ ${one_way} = "false" ]; then
	  telemetry_tx -r ${stream_tx} -u ${port_tx} -K ${keydir}/gs.key -B ${bandwidth} -M ${mcs_index} -S ${stbc} -L ${ldpc} -G ${guard_interval} -p ${fec} ${wlan} >/dev/null &
	fi
	telemetry_rx -r ${stream_rx} -c 127.0.0.1 -u ${port_rx} -K ${keydir}/gs.key ${wlan} >/dev/null &
  fi
  #for tablet osd (FPV-VR) as usb
  if [ -d "/sys/class/net/usb0" ]; then
      echo found usb0 device
      PHONE_IP=`ip route show 0.0.0.0/0 dev usb0 | cut -d\  -f3`
      echo usb-modem ip: ${PHONE_IP}
      MAVROUTARG=" -e ${PHONE_IP}:14550"
  fi
  #for tablet osd (FPV-VR) as AP
  if [ -d "/sys/class/net/${tab_wlan}" ]; then
      echo found ${tab_wlan} device
      TAB_IP=`ip route show 0.0.0.0/0 dev ${tab_wlan} | cut -d\  -f3`
      echo Tab AP ip: ${TAB_IP}
      MAVROUTARG=" -e ${TAB_IP}:14550"
  fi
  /usr/bin/mavlink-routerd -c /etc/mavlink.conf ${MAVROUTARG} &
  #/usr/sbin/mavfwd --master ${serial} --baudrate ${baud} --out 127.0.0.1:${port_tx} --in 127.0.0.1:${port_rx} >/dev/null &
  echo "Done."
}

stop_telemetry() {
  echo "Stopping telemetry service..."
	kill -9 $(pidof telemetry_rx)
	kill -9 $(pidof telemetry_tx)
	kill -9 $(pidof mavlink-routerd)
	kill -9 $(pidof mavfwd)
}

case "$1" in
  start)
      start_telemetry
	;;
  stop)
      stop_telemetry

	;;
	restart)
      stop_telemetry
      start_telemetry
	;;
    *)
	echo "Usage: $0 {start|stop|restart}"
	exit 1
esac
